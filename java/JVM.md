[toc]

## 整体架构
方法区、堆、java栈、本地方法栈、程序计数器

-Xss 256k 设置java栈大小

-Xms 表示堆区的起始内存
-Xmx 堆区的最大内存

新生代和老年代的参数设置：
-XX:NewRatio=2 表示新生代占1，老年代占2，新生代占整个堆的1/3
-XX:NewRatio=4 表示新生代占1，老年代占4，新生代占整个堆的1/5

新生代eden和s0，s1的比例：
一般eden和s0，s1的比例是8:1:1.

-XX:SurvivorRatio=8，这个就是上面的8:1:1.
可以通过-Xmn设置新生代最大内存大小,一般都使用默认值就行了

minor gc、major gc、full gc

minor gc就是young gc
针对老年代的gc是major gc
full gc：收集整个java堆和方法区的垃圾收集

minor gc非常频繁，回收速度也比较快，会引发STW，暂停其他用户线程，等垃圾回收结束，用户线程才恢复运行。
major gc速度一般比minor gc慢10倍以上，stw的时间更长。

## 直接内存
不是虚拟机运行时数据区的一部分，是在java堆外的、直接向系统申请的内存空间，来源于NIO，
访问直接内存速度会优先于java堆，读写性能高

## 垃圾回收
### 哪些是垃圾
1. 引用计数法：当一个对象不再被任何的存活对象继续引用时，就宣判死亡， 缺点，互相引用。 java里没有使用这类算法
2. 可达性分析：java选择的， 以根对象集合为起始点，按照从上至下的方式搜索被根对象所连接的目标对象是否可达，当一个对象没有任何引用链与gcroots连接就说明这个对象不可用。
gcroots对象：
a. 虚拟机栈中引用对象
b. 方法中类的静态属性引用对象
c. 方法区中常量引用对象
d. native方法引用的对象

### 垃圾回收的算法
1. 标记清除
2. 标记复制
3. 标记整理

在hotspot中，基于分代概念，年轻代用标记复制， 老年代因为大量存活率高的对象，不适合复制算法，一般是标记清除或者标记整理

内存溢出、内存泄漏。
内存泄漏：对象不会被程序用到了，但是gc又不能回收他们，比如数据库连接、网络连接，用完了没有close，也就不能被回收

### 垃圾回收器
按垃圾回收的线程数分，分为串行垃圾回收器和并行垃圾回收器。
同一时间段只允许有一个cpu用于执行垃圾回收操作，此时工作线程被暂停，直到垃圾收集工作结束。

按工作模式分：并发式垃圾回收器和独占式垃圾回收器。
并发式：与应用程序线程交替工作，尽可能减少应用程序的停顿时间。
独占式：一旦运行，停止应用程序中的所有用户线程。

按碎片处理方式：压缩式回收和非压缩。

按工作的内存区间：年轻代垃圾回收器和老年代垃圾回收器


新生代的回收器：serial gc、parallel scavenge gc、parnew gc
老年代：serial old gc、parallel old gc、cms gc
整堆收集器：g1

jdk8中使用 parallel scavenge gc  +  parallel old gc


serial是最早的，串行回收，young用复制算法，old用标记-整理算法

parallel scavenge gc 和parnew不同，parallel scavenge gc 目标是达到一个可控制的吞吐量，是吞吐量优先的垃圾收集器

cms：并发收集器，让垃圾收集线程与用户线程同时工作， 尽可能缩短垃圾收集时用户线程的停顿时间，采用标记-清除算法。

g1：在延迟可控的情况下，尽可能获取更高的吞吐量

## 常用命令
jps 查看java的进程 以及pid

jstack  java堆栈跟踪工具，生成当前时刻的线程快照， 主要目的是定位线程出现长时间停顿的原因，比如线程死锁、死循环、外部资源长时间等待等
最常用的是 jstack pid。 dump文件中线程状态主要就三个，runnable、blocked、waiting
也可以用来分析cpu过高，比如里面死循环，就会导致cpu过高。
1. top 查看各个进程cpu的使用情况，主要处理cpu使用率高的，可以找到pid
2. top -Hp pid 查看该进程下，各个线程的cpu使用情况
3. jstack pid ，这里的pid是2里面占用cpu高的线程的pid
4. jstack -l pid > log.txt 将堆栈信息打到文件里
5. 分析文件，将占用cpu过高的线程pid转为16进制，再去文件里搜索


jmap  堆转储快照dump的命令行工具，主要就是和堆相关，可以用VisualVM来分析生成的dump文件
jmap pid


jstat 对java程序的资源和性能进行实时的命令行监控，包括对heap size和垃圾回收的状况监控
jstat -gc 查看jvm中堆得垃圾收集情况